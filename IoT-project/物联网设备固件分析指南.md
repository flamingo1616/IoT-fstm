# 物联网设备固件分析指南

本测试指南旨在帮助安全从事行业中者快速了解物联网固件安全，掌握分析物联网设备技能，并具备深入研究和分析物联网设备漏洞的能力。 

**前言**

感谢以下各位师傅的辛勤付出，大家在阅读文章和学习的过程中遇到不妥当分析和描述，亦或者需要帮助的地方可直接通过邮箱联系各位师傅，同样也欢迎各位师傅的加入。

:handshake: Arrebol [中科院软件所 南京软件技术研究院] :e-mail:caojun@nj.iscas.ac.cn

:handshake:

:handshake:





## 环境配置

为了确保能够快速而顺利地进行固件安全测试，通常需要一个良好的分析环境，可以省去多数环境配置和软件安装依赖等问题。推荐以下两款常用于物联网领域的虚拟机attify和IOT-Research，虚拟机资源都是从互联网中收集，可根据自身需要选择是否使用。

### attify OS 虚拟机

[attify](https://github.com/adi0x90/attifyos) (虚拟机账户口令`iot`:`attify`)

下载地址：谷歌云盘 - <https://drive.google.com/drive/folders/1C5BKrpoCtxqZODbF0A-tt0UNjx-UmKt3>

![attifyos-home](images/attifyos-home.png)

**AttifyOS虚拟机安装步骤：**

1. 下载连接中提供的虚拟机文件，使用VMware workstation打开虚拟机(文件-->打开[Ctrl+O])，选中AttifyOS v3.0.ova文件。

![open-virtOS](images/open-virtOS.png)

2. 按照提示的步骤导入虚拟机 ，选择合适的路径存储新的虚拟机，等待虚拟机导入完成。

![waiting-OS-import](images/waiting-OS-import.png)

3. 导入成功就可以直接开启虚拟机，同时在虚拟机描述信息中也标明了账户和口令信息。

![attifyos-already](images/attifyos-already.png)

4. 开启虚拟机进入系统，默认用户iot，不需要登录口令。

![attify-os](images/attify-os.png)



### IOT-Research虚拟机

[IOT-Research](https://www.iotsec-zone.com/article/110)虚拟机账户口令：`iot`：`iot`

百度云盘的分享链接如下(提取码：`nqy3`)：
windows版虚拟机

> 链接： <https://pan.baidu.com/s/1ke6gvJ9sFlnpPE17O9nMuQ>

Mac M1版虚拟机

> 链接：<https://pan.baidu.com/s/10BIt97pd4XQUyraAINdicw>

下载好文件虚拟机后，同样的方式打开并登录虚拟机。

![iotsecOS](images/iotsecOS.png)

其中包含很多已经安装了很多常用的工具，例如binwalk、FirmAE 、flashrom等。

![iotsec-OS-tools](images/iotsec-OS-tools.png)





## 1. 获取固件

- 从供应商的support网站获取

对于固件获取，第一种最直接的方法就是通过官网的下载渠道，来获取相应的固件文件。首先找到官网的网址，根据官方提供的固件下载链接进行下载。例如获取DrayTek厂商的设备固件：https://www.draytek.com/support/resources/routers#version

![DrayTek-firmwares-download-page](images/DrayTek-firmwares-download-page.png)

也有部分厂商仅在官网提供最新版本的固件，当我们需要一些旧版本的固件时，不知道路径的话很难下载到。有部分厂商的多数固件都是放在某个FTP服务器目录下，知道地址即可获取到固件。例如DrayTek固件服务器：https://fw.draytek.com.tw/

![DrayTek-firmware-FTPserver](images/DrayTek-firmware-FTPserver.png)

当然，部分厂商的固件在国内的官网中是难以下载到的，或着国内厂商提供的固件并不是大家需要的，此时可以访问该厂商针对不同国家提供的官网页面进行下载。例如海康威视在国外和国内的官网提供的固件下载的数量和固件的排序方式存在较大差矣。在获取固件时多去不同地区的官网进行查找，往往有意想不到的收获。

HIKVISION EUROPE B.V 提供的固件

![hikvisionenrope-firmwares-download](images/hikvisionenrope-firmwares-download.png)

HIKVISION CHINA B.V 提供的固件

![hikvision-firmwares-download](images/hikvision-firmwares-download.png)

国内外常见路由器厂商的固件下载链接：

| 厂商           | 下载链接                                                     |
| -------------- | ------------------------------------------------------------ |
| D-LINK         | https://tsd.dlink.com.tw/ddwn                                |
|                | https://files.dlink.com.au/products/                         |
|                | http://www.dlink.com.cn/techsupport/                         |
| TOTOLINK       | https://www.totolink.net/home/index/menu_listtpl/listtpl/support/id/27.html |
| FAST           | https://service.fastcom.com.cn/download-list.html#0          |
| TP-LINK        | https://resource.tp-link.com.cn/?&productorlist=1&filterClass=[4] |
| MERCURY        | https://service.mercurycom.com.cn/download-list.html         |
| TENDA          | https://www.tenda.com.cn/download/cata-11.html               |
| NETCORE(磊科)  | https://www.netcoretec.com/service-support/download          |
| NETIS          | https://www.netis-systems.com/Suppory/down.html              |
| UTT(艾泰)      | https://www.utt.com.cn/downloadcenter.php                    |
| RUIJIE(锐捷)   | https://www.ruijie.com.cn/fw/rj/                             |
|                | https://www.ruijienetworks.com/resources/products/1896-1897  |
| WAYOS(维盟)    | https://www.wayos.com/fuwuzhici/xiazaizhongxin/              |
| ADSLR(飞鱼星)  | https://www.adslr.com/companyfile/2/                         |
|                | https://www.feiyuxing.com.cn/Downloads/                      |
| B-LINK         | https://www.b-link.net.cn/downloads_16.html                  |
| ASUS(华硕)     | https://www.asus.com.cn/support/Download-Center/             |
| DrayTek        | https://www.draytek.com/support/resources/routers#version    |
|                | https://fw.draytek.com.tw/                                   |
| NETGEAR        | http://support.netgear.cn/download.asp                       |
|                | https://www.cisco.com/c/zh_cn/support/all-products.html      |
| LB-LINK        | https://www.lb-link.com/support/downloads/                   |
| MIKROTIK       | https://mikrotik.com/download                                |
|                | http://46.167.242.10/firmware/mikrotik/                      |
| IKUAI(爱快)    | https://www.ikuai8.com/component/download                    |
| FORTINET(飞塔) | https://support.fortinet.com/Download/FirmwareImages.aspx    |
|                | https://it-help.tips/en/fortigate-firmware-download/         |
| MI(小米)       | http://www.miwifi.com/miwifi_download.html                   |
| H3C            | https://www.h3c.com/cn/Service/Document_Software/Software_Download/ |
| LINKSYS        | https://www.linksys.com/jp/linksys-support/                  |
| COMFAST        | http://www.comfast.com.cn/index.php?m=content&c=index&a=lists&catid=31 |
| 360            | https://luyou.360.cn/home/support/download?from=nav          |
| WAVLINK        | https://www.wavlink.com/zh_cn/firmware.html                  |
| IP-COM         | https://www.ip-com.com.cn/download/list-5.html               |


- 设备更新进行中间人（`MITM`）获取



 















- 通过 `UART`、`JTAG`、`PICit`等直接从硬件中提取

---

- 从主板卸下闪存芯片（如：SPI ）或 MCU，以进行离线分析和数据提取

  >  **不拆芯片读取固件**

使用夹子、钩子等连接导线，适合引脚较少的芯片。通过夹具夹住芯片引脚，然后连接编程器读取芯片内容，通过编程器连接芯片需要注意引脚的顺序，在 IC 芯片上都会有一个小点，大多数情况下，小点对应的引脚即为芯片的第一脚，而连接编程器的导线也需要插入编程器上相应的引脚。

这里以Winbond 25Q32JVSIQ芯片为例，可以看见图中芯片的右下角有一个小圆点，使用夹子的时候需要将引脚位置相互对应，通常夹子上的导线会有颜色标识，图中的红色导线就是第一脚连接的地方。同时需要正确的使用夹子夹住芯片，保证每个夹脚都正常的和芯片接触。

![clip-readfirmware](images/clip-readfirmware.png)

然后可以将夹子的另一端和对应的编程器连接，这里使用的是爱修的RT809F系列编程器，在网上能够轻松的购买到。然后在iFix爱修网下载并安装对应的编程器软件，详细安装过程请参考http://doc.ifix.net.cn/@rt809/CHN.html。

![connect-RT809F](images/connect-RT809F.jpg)

然后将编程器和电脑正确连接，然后打开编程器软件，对与常见的芯片只需要点击编程器软件中的智能识别，然后根据芯片上的信息进行校对。正确地在编程器软件中设置好芯片信息后，点击读取按钮固件就能够正常的从芯片中存储到本地中。

![RT809F-readfirmware](images/RT809F-readfirmware.png)

>  拆解芯片读取固件

拆解芯片所使用的硬件工具：热风焊台，恒温内热烙铁（尖头，刀头），吸锡带，吸锡器，助焊剂，松香，镊子，锡丝，隔热胶带等，在拆解芯片时记得提前在芯片引脚涂上助焊剂。

将热风枪的温度设置在350摄氏度左右，距离芯片1-2厘米，持续加热直到芯片引脚锡点融化，使用镊子轻轻触碰，能够感觉到明显的松动，就可以取下芯片。

将烙铁加热到400摄氏度左右，融化一截锡丝至芯片的引脚处，记得提前涂上助焊剂，然后将融化的锡球来回在芯片引脚拖动，来回拖动几次就能够轻松使用镊子取下芯片。

以下是以winbond  W29N0DN60012芯片为例，该芯片拥有48引脚，相比于常见的flash芯片(8pin或16pin)在拆解难度上更大。

![winbond-W29N0DN](images/winbond-W29N0DN.png)

将拆好的芯片表面的焊油擦拭干净，仔细观察芯片的引脚有没有被锡点粘连在一起的现象，使用锡球拖动时温度控制不好，这种芯片的引脚很容易发生粘连，如果发现粘连，在引脚涂上助焊剂使用烙铁仔细清理即可。

将拆解好的芯片放入48脚的底座中，然后使用RT809H编程卡住底座。使用的编程器依然是Ifix爱修的RT809H，当然也有其他可选的编程器，例如T48。

![chip-connet-pedestal](images/chip-connet-pedestal.jpg)

然后将编程器和电脑正确连接，然后打开编程器软件。编程器软件下载链接[国内版 - iFix爱修网](http://doc.ifix.net.cn/@rt809/CHN.html)，点击编程器软件中的智能识别，然后根据芯片上的信息进行校对，点击读取即可。

![RT809H-programmer](images/RT809H-programmer.png)



## 2. 分析固件

### 2.1 提取文件系统

binwalk

杂项工具，用于扫描隐藏文件，分离文件

安装：

```python
git clone https://github.com/ReFirmLabs/binwalk.git
cd binwalk
sudo python3 setup.py install
```

使用：

```python
binwalk filename

❯ binwalk 1.mp4
DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
27657186      0x1A603E2       PGP RSA encrypted session key - keyid: 7DEBB57A 854F782F RSA (Encrypt or Sign) 1024b
27820636      0x1A8825C       MySQL ISAM index file Version 8
28976826      0x1BA26BA       HPACK archive data
40994603      0x271872B       PNG image, 941 x 320, 8-bit/color RGBA, non-interlaced
40994644      0x2718754       Zlib compressed data, default compression
# 两列数字是偏移，可以 dd 手动分离
dd if=1.mp4 of=1.jpg skip=40994603 bs=1
# 这里if是指定输入文件，of是指定输出文件，skip是指定从输入文件开头跳过140147个块后再开始复制，bs设置每次读写块的大小为1字节 
```

可以使用 binwalk 的 `-e` 参数来提取固件中的文件

```python
binwalk -e test.bin
```

如果你还指定了 `-M` 选项，binwalk 会递归扫描文件

```python
binwalk -Me test.bin
```

如果指定了 `-r` 选项，则将自动删除无法提取的任何文件签名或导致大小为 0 的文件

```python
binwalk -Mre firmware.bin
```

还可以使用 binwalk 进行固件比较，指定 `-W` 选项
或者 -hexdump 指令

```python
binwalk -W test1 test2 test3
```





firmware-mod-kit

基于binwalk的解打包工具，但是由于很久没用更新，使用场景有限。

安装方法：

首先安装依赖

```python
sudo apt-get install git build-essential zlib1g-dev liblzma-dev python-magic
```

安装工具

```python
git clone https://github.com/mirror/firmware-mod-kit.git  
  
cd firmware-mod-kit/src  
  
./configure && make
```

解包固件
将固件 firmware.bin 解包到 working_directory/ 下

```python
./extract_firmware.sh firmware.bin working_directory/
```

重新打包固件
将新生成的固件放到 output_directory 下

```python
./build_firmware.sh output_directory/ working_directory/
```



基于binwalk的解打包工具，但是由于很久没用更新，使用场景有限。



### 2.2 分析文件系统

#### 2.2.1 手动分析

静态分析文件系统



#### 2.2.2 工具分析

借助一些自动化的工具对固件的文件系统进行分析

[firmwalker](https://github.com/craigz28/firmwalker)

[fwanalyzer](https://github.com/cruise-automation/fwanalyzer)



#### 2.2.3 动态分析

设备在正常运行或者在仿真环境中运行中的动态测试

借助调试工具GDB、FirmAE



## 3. 固件仿真



### 3.1 局部仿真

qemu-user

### 3.2 系统仿真

qemu-system

#### 自动化仿真工具

[firmware-analysis-toolkit](https://github.com/attify/firmware-analysis-toolkit)

[FirmAE](https://github.com/pr0v3rbs/FirmAE)

[firmdyne](https://github.com/firmadyne/firmadyne)

[EMUX](https://github.com/therealsaumil/emux)





## 4. 固件自动化分析工具

[FACT_core](https://github.com/fkie-cad/FACT_core)



[EMBA](https://github.com/e-m-b-a/emba)



[Podding](https://podding.cn/#/login)



## 5. 漏洞分析与利用





## 6. 漏洞挖掘思路与技巧





## 7. 固件解密





## 8. 安全社区

看雪学苑

IOT-ZONE



## 9. 安全论文

比较前沿的物联网安全的研究性文章



